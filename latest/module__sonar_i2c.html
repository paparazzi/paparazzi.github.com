<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Paparazzi UAS: sonar_i2c module</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="penguin_icon.png"/></td>
  <td id="projectalign">
   <div id="projectname">Paparazzi UAS<span id="projectnumber">&#160;v7.0_unstable</span>
   </div>
   <div id="projectbrief">Paparazzi is a free software Unmanned Aircraft System.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('module__sonar_i2c.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">sonar_i2c module</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><b>A Sonar with I2C connection can be used as unidirectional rangefinder</b></p>
<p>Examples of devices are e.g. Maxbotix MB1240 or a GY-US42V2. The sensor can be used as a distance-measuring tool to detect the range (distance) to a surfaces. Usecase for example: AGL hold,terrain following or landing assist.</p>
<p>To be able to use the I2C version of a Sonar, add this module to your airframe and set needed parameters.</p>
<p>Notes:</p><ul>
<li>The maximum useful detection distance is 4m for common sonar based small sized sensors, even if datasheet e.g. states 7m. For most I2C sonar range devices, a sampling rate of at least 15Hz is supported. However, if measurements are taken at longer distances, the time required for the ultrasonic pulse to return increases, which may limit the maximum achievable sampling rate. It is recommended to adjust the SONAR_I2C_PERIODIC_FREQUENCY parameter according to the sensor's capabilities and the expected measurement range to ensure reliable readings.</li>
<li>If the distance is read but the scale is incorrect, adjust the SONAR_I2C_SCALE parameter to match the sensor's specifications. The scale factor can also be determined experimentally by measuring a known distance and adjusting the scale until the output matches the expected value.</li>
<li>If the sensor is used in an airframe with landing gear, it is recommended to set the SONAR_I2C_OFFSET to the height of the landing gear, so that the AGL value is correct. Keep in mind that most sonar sensors have a deadzone of 0.15m to 0.25m, so the AGL cannot be measured if landinggear shorter than the deadzone range.</li>
<li>There is an option to compensate the AGL value for body rotation, which is useful if e.g. a roll maneuver, the sensor is not pointing straight down it compensates the AGL value for the body rotation.</li>
<li>Also an option to filter the sensor output is available, which is useful if the sensor is noisy or has a lot of outliers, in cas of a sonar, almost always the case.</li>
<li>An option to set a different I2C address is available in some hardware but not implemented to set dynamically in this driver. Use external tools to change the I2C address if needed and set the SONAR_I2C_ADDR parameter accordingly.</li>
<li>Distance compensation for pressure and temperature are not implemented, keep in mind that sonar sensors are susceptible to temperature and pressure changes.</li>
<li>To set the minimum and maximum range the sensor can reliably measure, use the SONAR_I2C_MIN_RANGE and SONAR_I2C_MAX_RANGE parameters. Note that if rotation compensation is enabled, the effective maximum range will be reduced when the vehicle rolls or pitches. If it is impossible to measure the distance reliable, the distance value will be set to NAN (not a number).</li>
<li>To restrict the AGL range define it in your airframefile with AGL_DIST_SONAR_MAX and AGL_DIST_SONAR_MIN</li>
</ul>
<h1><a class="anchor" id="module_load_example__sonar_i2c"></a>
Example for airframe file</h1>
<p>Add to your firmware section: This example contains all possible configuration options, not all of them are mandatory! </p><div class="fragment"><div class="line">&lt;<span class="keywordtype">module</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;sonar_i2c&quot;</span>&gt;</div>
<div class="line">  <span class="keyword">b</span><span class="stringliteral">&#39;&lt;define name=&quot;SONAR_I2C_USE_FILTER&quot; value=&quot;TRUE|FALSE&quot; /&gt;\n    &#39;</span></div>
<div class="line">  <span class="keyword">b</span><span class="stringliteral">&#39;&lt;define name=&quot;SONAR_I2C_MEDIAN_SIZE&quot; value=&quot;11&quot; /&gt;\n    &#39;</span></div>
<div class="line">  <span class="keyword">b</span><span class="stringliteral">&#39;&lt;define name=&quot;SONAR_I2C_SCALE&quot; value=&quot;0.00006&quot; /&gt;\n    &#39;</span></div>
<div class="line">  <span class="keyword">b</span><span class="stringliteral">&#39;&lt;define name=&quot;SONAR_I2C_OFFSET&quot; value=&quot;0.56&quot; /&gt;\n    &#39;</span></div>
<div class="line">  <span class="keyword">b</span><span class="stringliteral">&#39;&lt;define name=&quot;SONAR_I2C_MIN_RANGE&quot; value=&quot;0.33&quot; unit=&quot;m&quot; /&gt;\n    &#39;</span></div>
<div class="line">  <span class="keyword">b</span><span class="stringliteral">&#39;&lt;define name=&quot;SONAR_I2C_MAX_RANGE&quot; value=&quot;6.0&quot; unit=&quot;m&quot; /&gt;\n    &#39;</span></div>
<div class="line">  <span class="keyword">b</span><span class="stringliteral">&#39;&lt;define name=&quot;MODULE_SONAR_I2C_SYNC_SEND&quot; value=&quot;TRUE|FALSE&quot; /&gt;\n  &#39;</span></div>
<div class="line">  <span class="keyword">b</span><span class="stringliteral">&#39;&lt;configure name=&quot;SONAR_I2C_DEV&quot; value=&quot;i2cX&quot; /&gt;\n    &#39;</span></div>
<div class="line">  <span class="keyword">b</span><span class="stringliteral">&#39;&lt;configure name=&quot;SONAR_I2C_ADDR&quot; value=&quot;0xE0&quot; /&gt;\n    &#39;</span></div>
<div class="line">  <span class="keyword">b</span><span class="stringliteral">&#39;&lt;configure name=&quot;USE_SONAR_I2C_AGL&quot; value=&quot;TRUE|FALSE&quot; /&gt;\n    &#39;</span></div>
<div class="line">  <span class="keyword">b</span><span class="stringliteral">&#39;&lt;configure name=&quot;SONAR_I2C_COMPENSATE_ROTATION&quot; value=&quot;TRUE|FALSE&quot; /&gt;\n    &#39;</span></div>
<div class="line">  <span class="keyword">b</span><span class="stringliteral">&#39;&lt;configure name=&quot;SONAR_I2C_PERIODIC_FREQUENCY&quot; value=&quot;30&quot; /&gt;\n    &#39;</span></div>
<div class="line">&lt;/<span class="keywordtype">module</span>&gt;</div>
</div><!-- fragment --> <h1><a class="anchor" id="configuration__sonar_i2c"></a>
Module configuration options</h1>
<h2><a class="anchor" id="configure"></a>
Configure Options</h2>
<ul>
<li><b>name:</b> <code>SONAR_I2C_DEV</code> <b>value:</b> <em>i2cX</em> <br  />
 Description: I2C device port on flightcontroller to use for this device, e.g i2c2</li>
<li><b>name:</b> <code>SONAR_I2C_ADDR</code> <b>value:</b> <em>0xE0</em> <br  />
 Description: The I2C Slave address in 8bit of this device</li>
<li><b>name:</b> <code>USE_SONAR_I2C_AGL</code> <b>value:</b> <em>TRUE|FALSE</em> <br  />
 Description: Updates the AGL value in state,if not defined, defaults to FALSE</li>
<li><b>name:</b> <code>SONAR_I2C_COMPENSATE_ROTATION</code> <b>value:</b> <em>TRUE|FALSE</em> <br  />
 Description: Compensate AGL measurements for body rotation. Disabled by default</li>
<li><b>name:</b> <code>SONAR_I2C_PERIODIC_FREQUENCY</code> <b>value:</b> <em>30</em> <br  />
 Description: Sensor readings in HZ</li>
</ul>
<h2><a class="anchor" id="define"></a>
Define Options</h2>
<ul>
<li><b>name:</b> <code>SONAR_I2C_USE_FILTER</code> <b>value:</b> <em>TRUE|FALSE</em> <br  />
 Description: If this is enabled, a median filter on the distance output, defaults to TRUE</li>
<li><b>name:</b> <code>SONAR_I2C_MEDIAN_SIZE</code> <b>value:</b> <em>11</em> <br  />
 Description: If median filter is enabled then set this option to filter the output <a class="el" href="main__demo5_8c.html#ad690ee00a2cf77bbaaf89c3f1ef110d4">more(or less)</a>, default is 7</li>
<li><b>name:</b> <code>SONAR_I2C_SCALE</code> <b>value:</b> <em>0.00006</em> <br  />
 Description: Sensor scale for raw sensor output to a meter unit conversion,</li>
<li><b>name:</b> <code>SONAR_I2C_OFFSET</code> <b>value:</b> <em>0.56</em> <br  />
 Description: Sensor offset in meters, as in where one wants zero to be, default is 0.0</li>
<li><b>name:</b> <code>SONAR_I2C_MIN_RANGE</code> <b>value:</b> <em>0.33</em> <br  />
 Description: If defined, set limit to minimum value the sensor can reliably measure, default 0.25m</li>
<li><b>name:</b> <code>SONAR_I2C_MAX_RANGE</code> <b>value:</b> <em>6.0</em> <br  />
 Description: If defined, set limit to maximum value the sensor can reliably measure, default 4.0m</li>
<li><b>name:</b> <code>MODULE_SONAR_I2C_SYNC_SEND</code> <b>value:</b> <em>TRUE|FALSE</em> <br  />
 Description: Send RAW and scaled message with each new measurement,useful for debugging sensor issues (default: FALSE)</li>
</ul>
<h1><a class="anchor" id="functions__sonar_i2c"></a>
Module functions</h1>
<h2><a class="anchor" id="init_functions"></a>
Init Functions</h2>
<p>These initialization functions are called once on startup.</p>
<ul>
<li><a class="el" href="sonar__i2c_8c.html#acef6a387911dc98620af6de15905f5b8" title="Set the default values at initialization.">sonar_i2c_init()</a></li>
</ul>
<h2><a class="anchor" id="event_functions"></a>
Event Functions</h2>
<p>These event functions are called in each cycle of the module event loop.</p>
<ul>
<li><a class="el" href="sonar__i2c_8c.html#a5883c674e401657a33d7b960685a0923" title="Rangefinder event function Basically just check the progress of the transation to prevent overruns du...">sonar_i2c_event()</a></li>
</ul>
<h2><a class="anchor" id="periodic_functions"></a>
Periodic Functions</h2>
<p>These functions are called periodically at the specified frequency from the module periodic loop.</p>
<ul>
<li><a class="el" href="sonar__i2c_8c.html#af564f6db6a7628373df1f6a8b361fdad" title="Get the ranger current distance value.">sonar_i2c_periodic()</a><ul>
<li>Frequency in Hz: <em>SONAR_I2C_PERIODIC_FREQUENCY</em> </li>
<li>Autorun: <em>LOCK</em> <br  />
 Periodic function automatically starts after init and can't be stopped.</li>
</ul>
</li>
<li><a class="el" href="sonar__i2c_8c.html#a8aba3804bce58d1b40cb211711f5004d" title="Option to send debug informative values over telemetry if you do not want sonar message in telemetry.">sonar_i2c_report()</a><ul>
<li>Frequency in Hz: <em>10</em> </li>
<li>Autorun: <em>FALSE</em> <br  />
 Periodic function is started by user command.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="files"></a>
Files</h1>
<h2><a class="anchor" id="headers"></a>
Header Files</h2>
<p>The following headers are automatically included in modules.h</p>
<ul>
<li><a class="el" href="sonar__i2c_8h.html">sonar_i2c.h</a></li>
</ul>
<h2><a class="anchor" id="sources"></a>
Source Files</h2>
<ul>
<li><a class="el" href="sonar__i2c_8c.html">modules/sonar/sonar_i2c.c</a></li>
</ul>
<h2><a class="anchor" id="module_xml__sonar_i2c"></a>
Raw sonar_i2c.xml file:</h2>
<div class="fragment"><div class="line">&lt;!<span class="keyword">DOCTYPE</span> <span class="keyword">module</span> <span class="keyword">SYSTEM</span> <span class="stringliteral">&quot;module.dtd&quot;</span>&gt;</div>
<div class="line"> </div>
<div class="line">&lt;<span class="keywordtype">module</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;sonar_i2c&quot;</span> <span class="keyword">dir</span>=<span class="stringliteral">&quot;sonar&quot;</span>&gt;</div>
<div class="line">  &lt;<span class="keywordtype">doc</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">description</span>&gt;</div>
<div class="line">    <span class="keyword">A</span> <span class="keyword">Sonar</span> <span class="keyword">with</span> <span class="keyword">I2C</span> <span class="keyword">connection</span> <span class="keyword">can</span> <span class="keyword">be</span> <span class="keyword">used</span> <span class="keyword">as</span> <span class="keyword">unidirectional</span> <span class="keyword">rangefinder.</span> <span class="keyword">Examples</span> <span class="keyword">of</span> <span class="keyword">devices</span> <span class="keyword">are</span> <span class="keyword">e.g.</span> <span class="keyword">Maxbotix</span> <span class="keyword">MB1240</span> <span class="keyword">or</span> <span class="keyword">a</span> <span class="keyword">GY-US42V2.</span></div>
<div class="line">    <span class="keyword">The</span> <span class="keyword">sensor</span> <span class="keyword">can</span> <span class="keyword">be</span> <span class="keyword">used</span> <span class="keyword">as</span> <span class="keyword">a</span> <span class="keyword">distance-measuring</span> <span class="keyword">tool</span> <span class="keyword">to</span> <span class="keyword">detect</span> <span class="keyword">the</span> <span class="keyword">range</span> (<span class="keyword">distance</span>) <span class="keyword">to</span> <span class="keyword">a</span> <span class="keyword">surfaces.</span> <span class="keyword">Usecase</span> <span class="keyword">for</span> <span class="keyword">example:</span> <span class="keyword">AGL</span> <span class="keyword">hold</span>,<span class="keyword">terrain</span> <span class="keyword">following</span> <span class="keyword">or</span> <span class="keyword">landing</span> <span class="keyword">assist.</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">To</span> <span class="keyword">be</span> <span class="keyword">able</span> <span class="keyword">to</span> <span class="keyword">use</span> <span class="keyword">the</span> <span class="keyword">I2C</span> <span class="keyword">version</span> <span class="keyword">of</span> <span class="keyword">a</span> <span class="keyword">Sonar</span>, <span class="keyword">add</span> <span class="keyword">this</span> <span class="keyword">module</span> <span class="keyword">to</span> <span class="keyword">your</span> <span class="keyword">airframe</span> <span class="keyword">and</span> <span class="keyword">set</span> <span class="keyword">needed</span> <span class="keyword">parameters.</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">Notes:</span></div>
<div class="line">    + <span class="keyword">The</span> <span class="keyword">maximum</span> <span class="keyword">useful</span> <span class="keyword">detection</span> <span class="keyword">distance</span> <span class="keyword">is</span> 4<span class="keyword">m</span> <span class="keyword">for</span> <span class="keyword">common</span> <span class="keyword">sonar</span> <span class="keyword">based</span> <span class="keyword">small</span> <span class="keyword">sized</span> <span class="keyword">sensors</span>, <span class="keyword">even</span> <span class="keyword">if</span> <span class="keyword">datasheet</span> <span class="keyword">e.g.</span> <span class="keyword">states</span> 7<span class="keyword">m.</span></div>
<div class="line">    <span class="keyword">For</span> <span class="keyword">most</span> <span class="keyword">I2C</span> <span class="keyword">sonar</span> <span class="keyword">range</span> <span class="keyword">devices</span>, <span class="keyword">a</span> <span class="keyword">sampling</span> <span class="keyword">rate</span> <span class="keyword">of</span> <span class="keyword">at</span> <span class="keyword">least</span> 15<span class="keyword">Hz</span> <span class="keyword">is</span> <span class="keyword">supported.</span> <span class="keyword">However</span>, <span class="keyword">if</span> <span class="keyword">measurements</span> <span class="keyword">are</span> <span class="keyword">taken</span> <span class="keyword">at</span> <span class="keyword">longer</span> <span class="keyword">distances</span>, </div>
<div class="line">    <span class="keyword">the</span> <span class="keyword">time</span> <span class="keyword">required</span> <span class="keyword">for</span> <span class="keyword">the</span> <span class="keyword">ultrasonic</span> <span class="keyword">pulse</span> <span class="keyword">to</span> <span class="keyword">return</span> <span class="keyword">increases</span>, <span class="keyword">which</span> <span class="keyword">may</span> <span class="keyword">limit</span> <span class="keyword">the</span> <span class="keyword">maximum</span> <span class="keyword">achievable</span> <span class="keyword">sampling</span> <span class="keyword">rate.</span> </div>
<div class="line">    <span class="keyword">It</span> <span class="keyword">is</span> <span class="keyword">recommended</span> <span class="keyword">to</span> <span class="keyword">adjust</span> <span class="keyword">the</span> <span class="keyword">SONAR_I2C_PERIODIC_FREQUENCY</span> <span class="keyword">parameter</span> <span class="keyword">according</span> <span class="keyword">to</span> <span class="keyword">the</span> <span class="keyword">sensor</span><span class="stringliteral">&#39;s capabilities and the expected measurement range to ensure reliable readings.</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">    + If the distance is read but the scale is incorrect, adjust the SONAR_I2C_SCALE parameter to match the sensor&#39;</span><span class="keyword">s</span> <span class="keyword">specifications.</span></div>
<div class="line">    <span class="keyword">The</span> <span class="keyword">scale</span> <span class="keyword">factor</span> <span class="keyword">can</span> <span class="keyword">also</span> <span class="keyword">be</span> <span class="keyword">determined</span> <span class="keyword">experimentally</span> <span class="keyword">by</span> <span class="keyword">measuring</span> <span class="keyword">a</span> <span class="keyword">known</span> <span class="keyword">distance</span> <span class="keyword">and</span> <span class="keyword">adjusting</span> <span class="keyword">the</span> <span class="keyword">scale</span> <span class="keyword">until</span> <span class="keyword">the</span> <span class="keyword">output</span> <span class="keyword">matches</span> <span class="keyword">the</span> <span class="keyword">expected</span> <span class="keyword">value.</span></div>
<div class="line"> </div>
<div class="line">    + <span class="keyword">If</span> <span class="keyword">the</span> <span class="keyword">sensor</span> <span class="keyword">is</span> <span class="keyword">used</span> <span class="keyword">in</span> <span class="keyword">an</span> <span class="keyword">airframe</span> <span class="keyword">with</span> <span class="keyword">landing</span> <span class="keyword">gear</span>, <span class="keyword">it</span> <span class="keyword">is</span> <span class="keyword">recommended</span> <span class="keyword">to</span> <span class="keyword">set</span> <span class="keyword">the</span> <span class="keyword">SONAR_I2C_OFFSET</span> <span class="keyword">to</span> <span class="keyword">the</span> <span class="keyword">height</span> <span class="keyword">of</span> <span class="keyword">the</span> <span class="keyword">landing</span> <span class="keyword">gear</span>, <span class="keyword">so</span> <span class="keyword">that</span> <span class="keyword">the</span> <span class="keyword">AGL</span> <span class="keyword">value</span> <span class="keyword">is</span> <span class="keyword">correct.</span> </div>
<div class="line">    <span class="keyword">Keep</span> <span class="keyword">in</span> <span class="keyword">mind</span> <span class="keyword">that</span> <span class="keyword">most</span> <span class="keyword">sonar</span> <span class="keyword">sensors</span> <span class="keyword">have</span> <span class="keyword">a</span> <span class="keyword">deadzone</span> <span class="keyword">of</span> 0.15<span class="keyword">m</span> <span class="keyword">to</span> 0.25<span class="keyword">m</span>, <span class="keyword">so</span> <span class="keyword">the</span> <span class="keyword">AGL</span> <span class="keyword">cannot</span> <span class="keyword">be</span> <span class="keyword">measured</span> <span class="keyword">if</span> <span class="keyword">landinggear</span> <span class="keyword">shorter</span> <span class="keyword">than</span> <span class="keyword">the</span> <span class="keyword">deadzone</span> <span class="keyword">range.</span></div>
<div class="line"> </div>
<div class="line">    + <span class="keyword">There</span> <span class="keyword">is</span> <span class="keyword">an</span> <span class="keyword">option</span> <span class="keyword">to</span> <span class="keyword">compensate</span> <span class="keyword">the</span> <span class="keyword">AGL</span> <span class="keyword">value</span> <span class="keyword">for</span> <span class="keyword">body</span> <span class="keyword">rotation</span>, <span class="keyword">which</span> <span class="keyword">is</span> <span class="keyword">useful</span> <span class="keyword">if</span> <span class="keyword">e.g.</span> <span class="keyword">a</span> <span class="keyword">roll</span> <span class="keyword">maneuver</span>, <span class="keyword">the</span> <span class="keyword">sensor</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">pointing</span> <span class="keyword">straight</span> <span class="keyword">down</span> <span class="keyword">it</span> <span class="keyword">compensates</span> <span class="keyword">the</span> <span class="keyword">AGL</span> <span class="keyword">value</span> <span class="keyword">for</span> <span class="keyword">the</span> <span class="keyword">body</span> <span class="keyword">rotation.</span></div>
<div class="line">    </div>
<div class="line">    + <span class="keyword">Also</span> <span class="keyword">an</span> <span class="keyword">option</span> <span class="keyword">to</span> <span class="keyword">filter</span> <span class="keyword">the</span> <span class="keyword">sensor</span> <span class="keyword">output</span> <span class="keyword">is</span> <span class="keyword">available</span>, <span class="keyword">which</span> <span class="keyword">is</span> <span class="keyword">useful</span> <span class="keyword">if</span> <span class="keyword">the</span> <span class="keyword">sensor</span> <span class="keyword">is</span> <span class="keyword">noisy</span> <span class="keyword">or</span> <span class="keyword">has</span> <span class="keyword">a</span> <span class="keyword">lot</span> <span class="keyword">of</span> <span class="keyword">outliers</span>, <span class="keyword">in</span> <span class="keyword">cas</span> <span class="keyword">of</span> <span class="keyword">a</span> <span class="keyword">sonar</span>, <span class="keyword">almost</span> <span class="keyword">always</span> <span class="keyword">the</span> <span class="keyword">case.</span></div>
<div class="line">    </div>
<div class="line">    + <span class="keyword">An</span> <span class="keyword">option</span> <span class="keyword">to</span> <span class="keyword">set</span> <span class="keyword">a</span> <span class="keyword">different</span> <span class="keyword">I2C</span> <span class="keyword">address</span> <span class="keyword">is</span> <span class="keyword">available</span> <span class="keyword">in</span> <span class="keyword">some</span> <span class="keyword">hardware</span> <span class="keyword">but</span> <span class="keyword">not</span> <span class="keyword">implemented</span> <span class="keyword">to</span> <span class="keyword">set</span> <span class="keyword">dynamically</span> <span class="keyword">in</span> <span class="keyword">this</span> <span class="keyword">driver.</span> </div>
<div class="line">    <span class="keyword">Use</span> <span class="keyword">external</span> <span class="keyword">tools</span> <span class="keyword">to</span> <span class="keyword">change</span> <span class="keyword">the</span> <span class="keyword">I2C</span> <span class="keyword">address</span> <span class="keyword">if</span> <span class="keyword">needed</span> <span class="keyword">and</span> <span class="keyword">set</span> <span class="keyword">the</span> <span class="keyword">SONAR_I2C_ADDR</span> <span class="keyword">parameter</span> <span class="keyword">accordingly.</span></div>
<div class="line"> </div>
<div class="line">    + <span class="keyword">Distance</span> <span class="keyword">compensation</span> <span class="keyword">for</span> <span class="keyword">pressure</span> <span class="keyword">and</span> <span class="keyword">temperature</span> <span class="keyword">are</span> <span class="keyword">not</span> <span class="keyword">implemented</span>, <span class="keyword">keep</span> <span class="keyword">in</span> <span class="keyword">mind</span> <span class="keyword">that</span> <span class="keyword">sonar</span> <span class="keyword">sensors</span> <span class="keyword">are</span> <span class="keyword">susceptible</span> <span class="keyword">to</span> <span class="keyword">temperature</span> <span class="keyword">and</span> <span class="keyword">pressure</span> <span class="keyword">changes.</span> </div>
<div class="line"> </div>
<div class="line">    + <span class="keyword">To</span> <span class="keyword">set</span> <span class="keyword">the</span> <span class="keyword">minimum</span> <span class="keyword">and</span> <span class="keyword">maximum</span> <span class="keyword">range</span> <span class="keyword">the</span> <span class="keyword">sensor</span> <span class="keyword">can</span> <span class="keyword">reliably</span> <span class="keyword">measure</span>, <span class="keyword">use</span> <span class="keyword">the</span> <span class="keyword">SONAR_I2C_MIN_RANGE</span> <span class="keyword">and</span> <span class="keyword">SONAR_I2C_MAX_RANGE</span> <span class="keyword">parameters.</span></div>
<div class="line">      <span class="keyword">Note</span> <span class="keyword">that</span> <span class="keyword">if</span> <span class="keyword">rotation</span> <span class="keyword">compensation</span> <span class="keyword">is</span> <span class="keyword">enabled</span>, <span class="keyword">the</span> <span class="keyword">effective</span> <span class="keyword">maximum</span> <span class="keyword">range</span> <span class="keyword">will</span> <span class="keyword">be</span> <span class="keyword">reduced</span> <span class="keyword">when</span> <span class="keyword">the</span> <span class="keyword">vehicle</span> <span class="keyword">rolls</span> <span class="keyword">or</span> <span class="keyword">pitches.</span></div>
<div class="line">      <span class="keyword">If</span> <span class="keyword">it</span> <span class="keyword">is</span> <span class="keyword">impossible</span> <span class="keyword">to</span> <span class="keyword">measure</span> <span class="keyword">the</span> <span class="keyword">distance</span> <span class="keyword">reliable</span>, <span class="keyword">the</span> <span class="keyword">distance</span> <span class="keyword">value</span> <span class="keyword">will</span> <span class="keyword">be</span> <span class="keyword">set</span> <span class="keyword">to</span> <span class="keyword">NAN</span> (<span class="keyword">not</span> <span class="keyword">a</span> <span class="keyword">number</span>).</div>
<div class="line"> </div>
<div class="line">    + <span class="keyword">To</span> <span class="keyword">restrict</span> <span class="keyword">the</span> <span class="keyword">AGL</span> <span class="keyword">range</span> <span class="keyword">define</span> <span class="keyword">it</span> <span class="keyword">in</span> <span class="keyword">your</span> <span class="keyword">airframefile</span> <span class="keyword">with</span> <span class="keyword">AGL_DIST_SONAR_MAX</span> <span class="keyword">and</span> <span class="keyword">AGL_DIST_SONAR_MIN</span></div>
<div class="line"> </div>
<div class="line">    &lt;/<span class="keywordtype">description</span>&gt;   </div>
<div class="line">    &lt;<span class="keywordtype">configure</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;SONAR_I2C_DEV&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;i2cX&quot;</span> <span class="keyword">description</span>=<span class="stringliteral">&quot;I2C device port on flightcontroller to use for this device, e.g i2c2&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">configure</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;SONAR_I2C_ADDR&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;0xE0&quot;</span> <span class="keyword">description</span>=<span class="stringliteral">&quot;The I2C Slave address in 8bit of this device&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">configure</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;USE_SONAR_I2C_AGL&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;TRUE|FALSE&quot;</span> <span class="keyword">description</span>=<span class="stringliteral">&quot;Updates the AGL value in state,if not defined, defaults to FALSE&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">configure</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;SONAR_I2C_COMPENSATE_ROTATION&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;TRUE|FALSE&quot;</span> <span class="keyword">description</span>=<span class="stringliteral">&quot;Compensate AGL measurements for body rotation. Disabled by default&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">configure</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;SONAR_I2C_PERIODIC_FREQUENCY&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;30&quot;</span> <span class="keyword">description</span>=<span class="stringliteral">&quot;Sensor readings in HZ&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;SONAR_I2C_USE_FILTER&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;TRUE|FALSE&quot;</span> <span class="keyword">description</span>=<span class="stringliteral">&quot;If this is enabled, a median filter on the distance output, defaults to TRUE&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;SONAR_I2C_MEDIAN_SIZE&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;11&quot;</span> <span class="keyword">description</span>=<span class="stringliteral">&quot;If median filter is enabled then set this option to filter the output more(or less), default is 7&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;SONAR_I2C_SCALE&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;0.00006&quot;</span> <span class="keyword">description</span>=<span class="stringliteral">&quot;Sensor scale for raw sensor output to a meter unit conversion, &quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;SONAR_I2C_OFFSET&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;0.56&quot;</span>  <span class="keyword">description</span>=<span class="stringliteral">&quot;Sensor offset in meters, as in where one wants zero to be, default is 0.0&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;SONAR_I2C_MIN_RANGE&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;0.33&quot;</span> <span class="keyword">unit</span>=<span class="stringliteral">&quot;m&quot;</span> <span class="keyword">description</span>=<span class="stringliteral">&quot;If defined, set limit to minimum value the sensor can reliably measure, default 0.25m&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;SONAR_I2C_MAX_RANGE&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;6.0&quot;</span> <span class="keyword">unit</span>=<span class="stringliteral">&quot;m&quot;</span> <span class="keyword">description</span>=<span class="stringliteral">&quot;If defined, set limit to maximum value the sensor can reliably measure, default 4.0m&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;MODULE_SONAR_I2C_SYNC_SEND&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;TRUE|FALSE&quot;</span> <span class="keyword">description</span>=<span class="stringliteral">&quot;Send RAW and scaled message with each new measurement,useful for debugging sensor issues (default: FALSE)&quot;</span>/&gt;</div>
<div class="line">  &lt;/<span class="keywordtype">doc</span>&gt;</div>
<div class="line"> </div>
<div class="line">  &lt;<span class="keywordtype">settings</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">dl_settings</span> <span class="keyword">NAME</span>=<span class="stringliteral">&quot;Rangefinder&quot;</span>&gt;</div>
<div class="line">      &lt;<span class="keywordtype">dl_settings</span> <span class="keyword">NAME</span>=<span class="stringliteral">&quot;Sonar I2C&quot;</span>&gt;</div>
<div class="line">        &lt;<span class="keywordtype">dl_setting</span> <span class="keyword">MAX</span>=<span class="stringliteral">&quot;1&quot;</span> <span class="keyword">MIN</span>=<span class="stringliteral">&quot;0&quot;</span> <span class="keyword">STEP</span>=<span class="stringliteral">&quot;1&quot;</span> <span class="keyword">VAR</span>=<span class="stringliteral">&quot;sonar_i2c.update_agl&quot;</span> <span class="keyword">shortname</span>=<span class="stringliteral">&quot;Update AGL&quot;</span>/&gt;</div>
<div class="line">      &lt;/<span class="keywordtype">dl_settings</span>&gt;</div>
<div class="line">    &lt;/<span class="keywordtype">dl_settings</span>&gt;</div>
<div class="line">  &lt;/<span class="keywordtype">settings</span>&gt;</div>
<div class="line">  &lt;<span class="keywordtype">dep</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">depends</span>&gt;<span class="keyword">i2c</span>&lt;/<span class="keywordtype">depends</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">provides</span>&gt;<span class="keyword">sonar</span>&lt;/<span class="keywordtype">provides</span>&gt;</div>
<div class="line">  &lt;/<span class="keywordtype">dep</span>&gt;</div>
<div class="line"> </div>
<div class="line">  &lt;<span class="keywordtype">header</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">file</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;sonar_i2c.h&quot;</span>/&gt;</div>
<div class="line">  &lt;/<span class="keywordtype">header</span>&gt;</div>
<div class="line">  &lt;<span class="keywordtype">init</span> <span class="keyword">fun</span>=<span class="stringliteral">&quot;sonar_i2c_init()&quot;</span>/&gt;</div>
<div class="line">  &lt;<span class="keywordtype">periodic</span> <span class="keyword">fun</span>=<span class="stringliteral">&quot;sonar_i2c_periodic()&quot;</span> <span class="keyword">freq</span>=<span class="stringliteral">&quot;SONAR_I2C_PERIODIC_FREQUENCY&quot;</span>/&gt;</div>
<div class="line">  &lt;<span class="keywordtype">periodic</span> <span class="keyword">fun</span>=<span class="stringliteral">&quot;sonar_i2c_report()&quot;</span> <span class="keyword">freq</span>=<span class="stringliteral">&quot;10&quot;</span> <span class="keyword">autorun</span>=<span class="stringliteral">&quot;FALSE&quot;</span>/&gt;</div>
<div class="line">  &lt;<span class="keywordtype">event</span> <span class="keyword">fun</span>=<span class="stringliteral">&quot;sonar_i2c_event()&quot;</span>/&gt;</div>
<div class="line">  &lt;<span class="keywordtype">makefile</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">configure</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;SONAR_I2C_DEV&quot;</span> <span class="keyword">default</span>=<span class="stringliteral">&quot;i2c1&quot;</span> <span class="keyword">case</span>=<span class="stringliteral">&quot;lower|upper&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">configure</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;SONAR_I2C_ADDR&quot;</span> <span class="keyword">default</span>=<span class="stringliteral">&quot;0xE0&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">configure</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;USE_SONAR_I2C_AGL&quot;</span> <span class="keyword">default</span>=<span class="stringliteral">&quot;0&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">configure</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;SONAR_I2C_COMPENSATE_ROTATION&quot;</span> <span class="keyword">default</span>=<span class="stringliteral">&quot;0&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">configure</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;SONAR_I2C_PERIODIC_FREQUENCY&quot;</span> <span class="keyword">default</span>=<span class="stringliteral">&quot;30&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;USE_$(SONAR_I2C_DEV_UPPER)&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;SONAR_I2C_DEV&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;$(SONAR_I2C_DEV_LOWER)&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;SONAR_I2C_ADDR&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;$(SONAR_I2C_ADDR)&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;USE_SONAR_I2C_AGL&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;$(USE_SONAR_I2C_AGL)&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;SONAR_I2C_COMPENSATE_ROTATION&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;$(SONAR_I2C_COMPENSATE_ROTATION)&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;SONAR_I2C_PERIODIC_FREQUENCY&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;$(SONAR_I2C_PERIODIC_FREQUENCY)&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">file</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;sonar_i2c.c&quot;</span>/&gt;</div>
<div class="line">  &lt;/<span class="keywordtype">makefile</span>&gt;</div>
<div class="line">  &lt;<span class="keywordtype">makefile</span> <span class="keyword">target</span>=<span class="stringliteral">&quot;nps&quot;</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">define</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;USE_SONAR&quot;</span> <span class="keyword">value</span>=<span class="stringliteral">&quot;TRUE&quot;</span>/&gt;<span class="comment">&lt;!-- in NPS use a virtual sonar to simulate rangeing measurements --&gt;</span></div>
<div class="line">  &lt;/<span class="keywordtype">makefile</span>&gt;</div>
<div class="line">&lt;/<span class="keywordtype">module</span>&gt;</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="onboard_modules.html">Onboard Modules</a></li>
    <li class="footer">Generated on Mon Sep 22 2025 20:28:39 for Paparazzi UAS by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
